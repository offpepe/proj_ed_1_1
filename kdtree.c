#include <stdio.h>
#include <stdlib.h>
#include <float.h>
#include <string.h>
#include <assert.h>
#include <math.h>

#include "heap/heap.h"

#define EMBED_SIZE 128

/*Definições desenvolvedor usuario*/
typedef struct _reg
{
    float embed[EMBED_SIZE];
    char nome[100];
} treg;

typedef struct _node
{
    void *key;
    struct _node *esq;
    struct _node *dir;
} tnode;

typedef struct _arv
{
    tnode *raiz;
    int (*cmp)(void *, void *, int);
    double (*dist)(void *, void *);
    int k;
    Heap *distHeap;
} tarv;

void *aloca_reg(float *embed, char nome[])
{
    treg *reg = malloc(sizeof(treg));
    memcpy(reg->embed, embed, sizeof(float) * EMBED_SIZE);
    strcpy(reg->nome, nome);
    return reg;
}

int comparador(void *a, void *b, int pos)
{
    float x = ((treg *)a)->embed[pos];
    float y = ((treg *)b)->embed[pos];
    if (x > y)
        return 1;
    if (y > x)
        return -1;
    return 0;
}

double distancia(void *a, void *b)
{
    double sum = 0, diff = 0;
    for (int i = 0; i < EMBED_SIZE; i++)
    {
        diff = ((treg *)a)->embed[i] - ((treg *)b)->embed[i];
        sum += (diff * diff);
    }
    return sqrt(sum);
}

void kdtree_constroi(tarv *arv, int (*cmp)(void *a, void *b, int), double (*dist)(void *, void *), int k)
{
    arv->raiz = NULL;
    arv->cmp = cmp;
    arv->dist = dist;
    arv->k = k;
    arv->distHeap = construct_heap(5);
}

/*teste*/
void test_constroi()
{
    /* arrange */
    tarv arv;
    tnode node1;
    tnode node2;
    float embedTest1[] = {-0.3444824516773224, 0.3957308530807495, 1.1916395425796509, -0.5949933528900146, -0.06057170033454895, -0.2755972146987915, 0.6691650152206421, 0.78949373960495, 1.199083924293518, 1.5521435737609863, -1.787296175956726, 0.1690875142812729, -1.1313554048538208, 0.6233354806900024, -0.8923656940460205, -0.8250806927680969, -1.9628963470458984, -0.9626147747039795, -1.3179712295532227, -1.1844661235809326, 0.7339369058609009, -1.074603796005249, -0.915801465511322, -0.8999994993209839, -2.680684804916382, 0.8732487559318542, -0.6657688617706299, -0.6124828457832336, 0.04938749223947525, 1.042906641960144, 0.27802640199661255, 0.63856041431427, 0.47814053297042847, -1.9650886058807373, 1.220073938369751, -0.969035804271698, -2.018221139907837, 0.640932023525238, 0.7077299952507019, 0.8216730356216431, -0.6868153810501099, 0.32834339141845703, -0.3908195197582245, 0.10912209749221802, -0.3966069221496582, -0.2523846924304962, -0.5121811628341675, 1.7615693807601929, -1.123538613319397, -0.06918759644031525, 1.6276580095291138, 1.7832202911376953, 0.21234163641929626, -1.2876864671707153, 1.0771729946136475, -0.5904300212860107, -0.42133599519729614, -0.49832862615585327, -0.575025200843811, 1.518068790435791, 0.1255861222743988, -0.17974816262722015, -3.0156195163726807, -0.7997176647186279, 0.5721785426139832, -0.2930648922920227, -1.068603754043579, 1.684072732925415, 0.8004893660545349, 0.10932427644729614, -0.47739702463150024, -0.2639109194278717, 1.1439850330352783, -1.498402714729309, 1.5997024774551392, 0.9678308963775635, -0.42338722944259644, -0.44528138637542725, -0.6675369143486023, -1.591376543045044, 0.5033718943595886, -0.33471179008483887, 0.6122221946716309, -1.830485463142395, -1.9930661916732788, -1.024031162261963, -1.019924521446228, -0.5520651340484619, 1.4305510520935059, 0.190659299492836, -2.0403659343719482, 1.1248588562011719, -0.14571087062358856, 0.030190741643309593, 1.0649715662002563, 1.742930293083191, -1.176995873451233, 1.1136448383331299, 0.17300260066986084, -0.5261322259902954, 1.445635437965393, -0.04272829741239548, -3.1843690872192383, -1.400330901145935, 0.026010915637016296, -1.8383736610412598, 1.393062949180603, 0.11060348153114319, 1.440458059310913, 0.5884268283843994, 0.24727804958820343, 0.024794183671474457, -1.691043496131897, -0.6011244654655457, -1.011088252067566, 1.9053137302398682, 0.24062293767929077, -0.113981693983078, -1.136901617050171, -0.2654804289340973, 0.6875818967819214, -1.221598744392395, -1.4060215950012207, -0.2692178189754486, 0.06177660450339317, -0.08551202714443207, -0.790888249874115, -0.0527612641453743};
    float embedTest2[] = {-1.3849472999572754, -1.60749351978302, -0.17812448740005493, 0.5906571745872498, 0.9500745534896851, 1.2525949478149414, 0.34809428453445435, -0.19931043684482574, -0.36474910378456116, 1.8318804502487183, -0.4813762307167053, -1.7760344743728638, -0.22427688539028168, -0.8710949420928955, 0.5383366346359253, -0.29620057344436646, 1.538888692855835, -0.7108375430107117, -0.8333165049552917, -2.027801036834717, 0.5600541830062866, -0.5367048978805542, 0.8397340178489685, 0.9077188372612, -1.0174446105957031, -0.4252755343914032, 0.20350989699363708, -0.8788813352584839, -0.03247920423746109, 1.3429350852966309, 1.6828291416168213, -0.8164694309234619, 0.47501713037490845, -0.01259208470582962, 2.594102382659912, -0.34086722135543823, -1.1662253141403198, -0.21766585111618042, 1.0727310180664062, -0.38852277398109436, -0.3832145631313324, -0.21825340390205383, 0.8347722291946411, 0.19983837008476257, 1.1856881380081177, -0.8957820534706116, 0.775351881980896, -0.11067003011703491, -0.6185272336006165, -0.17154410481452942, -0.902362048625946, 0.8258640170097351, -0.15261483192443848, -0.6849628686904907, -0.7634403705596924, 0.9967895150184631, 0.9683685898780823, -1.7096360921859741, -0.7820016741752625, -1.594185471534729, -0.5965757966041565, -0.8294951915740967, 0.629070520401001, 0.13321374356746674, -1.1475613117218018, -0.34469538927078247, -0.13987493515014648, 1.2820230722427368, -1.2778412103652954, 0.019802898168563843, 0.5385782718658447, -0.20292089879512787, 0.20760442316532135, -2.3865647315979004, 1.7628028392791748, 0.35197123885154724, -0.19459958374500275, -0.12238436937332153, -2.027294635772705, -0.1903497725725174, -0.05181869864463806, 0.5272862911224365, -1.5566132068634033, -0.2354068160057068, 0.6722084283828735, -0.1996586173772812, -0.6255888938903809, -0.6845024228096008, -1.2259342670440674, -0.1397804617881775, -0.4060962498188019, 0.8317999243736267, -0.6176996827125549, 1.7343350648880005, 0.5526726245880127, 0.35262787342071533, -1.040667176246643, 0.7661591172218323, -1.5204484462738037, 0.12556348741054535, 0.916591227054596, 0.0010061822831630707, -0.3697841167449951, -0.5433762669563293, 0.20547953248023987, 0.09690067172050476, -1.3781213760375977, -1.2220051288604736, -0.013981908559799194, -0.023583021014928818, -0.8941890001296997, 1.4628125429153442, 0.23042917251586914, 0.1768122762441635, -1.0837717056274414, -0.712164044380188, -0.23876874148845673, -1.5390522480010986, -1.731106162071228, 0.6274563074111938, 0.6065899729728699, -1.4475351572036743, 1.525938868522644, -0.2932230234146118, 0.2395395189523697, -0.96598881483078, 0.9600178003311157, 0.5076695680618286};
    node1.key = aloca_reg(embedTest1, "Edson");
    node2.key = aloca_reg(embedTest2, "Alan");
    /* act */
    kdtree_constroi(&arv, comparador, distancia, 2);

    /* assert */
    assert(arv.raiz == NULL);
    assert(arv.k == 2);
    assert(arv.cmp(node1.key, node2.key, 0) == 1);
    assert(arv.cmp(node1.key, node2.key, 1) == 1);
    assert(strcpy(((treg *)node1.key)->nome, "Dourados"));
    assert(strcpy(((treg *)node2.key)->nome, "Campo Grande"));
    free(node1.key);
    free(node2.key);
}

void _kdtree_insere(tnode **node, void *key, int (*cmp)(void *a, void *b, int), int profund, int k)
{
    if (*node == NULL)
    {
        *node = malloc(sizeof(tnode));
        (*node)->key = key;
        (*node)->esq = NULL;
        (*node)->dir = NULL;
        return;
    }
    int pos = profund % k;
    if (cmp((*(*node)).key, key, pos) < 0)
    {
        _kdtree_insere(&((*node)->dir), key, cmp, profund + 1, k);
    }
    else
    {
        _kdtree_insere(&((*node)->esq), key, cmp, profund + 1, k);
    }
}

void kdtree_insere(tarv *arv, void *key)
{
    _kdtree_insere(&(arv->raiz), key, arv->cmp, 0, arv->k);
}

void _kdtree_destroi(tnode *node)
{
    if (node == NULL)
        return;
    _kdtree_destroi(node->esq);
    _kdtree_destroi(node->dir);
    free(node->key);
    free(node);
}

void kdtree_destroi(tarv *arv)
{
    _kdtree_destroi(arv->raiz);
}

void _kdtree_busca(tarv *arv, tnode **atual, void *key, int profund, double *menor_dist, tnode **menor)
{
    tnode **lado_principal;
    tnode **lado_oposto;
    if (*atual == NULL)
        return;
    double dist_atual = arv->dist((*atual)->key, key);
    if (dist_atual < *menor_dist)
    {
        *menor_dist = dist_atual;
        *menor = *atual;
    }
    int pos = profund % arv->k;
    int comp = arv->cmp(key, (*atual)->key, pos);

    printf("%s dist %4.3f menor_dist %4.3f comp %d\n", ((treg *)((tnode *)*atual)->key)->nome, dist_atual, *menor_dist, comp);

    /* define lado principal para buscar */
    if (comp < 0)
    {
        lado_principal = &((*atual)->esq);
        lado_oposto = &((*atual)->dir);
    }
    else
    {
        lado_principal = &((*atual)->dir);
        lado_oposto = &((*atual)->esq);
    }

    _kdtree_busca(arv, lado_principal, key, profund + 1, menor_dist, menor);

    /* Verifica se deve buscar também no outro lado*/

    if (comp * comp < *menor_dist)
    {
        printf("tentando do outro lado %f\n", comp * comp);
        _kdtree_busca(arv, lado_oposto, key, profund + 1, menor_dist, menor);
    }
}

tnode *kdtree_busca(tarv *arv, void *key)
{
    tnode *menor = NULL;
    double menor_dist = DBL_MAX;
    _kdtree_busca(arv, &(arv->raiz), key, 0, &menor_dist, &menor);
    return menor;
}

treg buscar_mais_proximo(tarv *arv, treg query)
{
    double menor_dist = 1e20;
    tnode *menor = NULL;
    _kdtree_busca(arv, &(arv->raiz), &query, 0, &menor_dist, &menor);
    return *((treg *)(menor->key));
}

tarv arvore_global;

tarv *get_tree()
{
    return &arvore_global;
}

void inserir_ponto(treg p)
{
    treg *novo = malloc(sizeof(treg));
    *novo = p; // cópia de estrutura
    kdtree_insere(&arvore_global, novo);
}
void kdtree_construir()
{
    arvore_global.k = 2;
    arvore_global.dist = distancia;
    arvore_global.cmp = comparador;
    arvore_global.raiz = NULL;
}

void test_busca()
{
    tarv arv;
    kdtree_constroi(&arv, comparador, distancia, 2);
    float emb1[] = {-0.6606470346450806, -0.38912487030029297, -0.02702479064464569, -0.40551942586898804, -1.331418514251709, -1.382637858390808, 1.8948986530303955, 1.0168429613113403, -0.032298315316438675, 0.3915473222732544, 0.5886815786361694, -0.0601578950881958, -1.4178510904312134, -0.2240332067012787, 0.44909170269966125, 0.4342969059944153, 1.0224806070327759, -0.3018597960472107, -0.12344954907894135, -0.5285488963127136, -0.620755672454834, 0.7514500617980957, -0.4299977421760559, 0.03167472779750824, 0.9719557762145996, 1.7110146284103394, 1.1868575811386108, -0.48066383600234985, 0.10836763679981232, -1.6088342666625977, -0.28481051325798035, -0.2275848239660263, -0.5941258668899536, 1.2276976108551025, 1.7263941764831543, 0.9647353291511536, 0.6341955065727234, -0.8669033050537109, 1.3910338878631592, -0.8636852502822876, -2.178661584854126, 0.6316053867340088, -0.0011781305074691772, 0.6354781985282898, 1.3411251306533813, 0.7902469038963318, -0.06642121076583862, -0.8141146898269653, -0.6096173524856567, 0.3121083378791809, 0.37575048208236694, -0.5741226673126221, -1.5621330738067627, 0.5987110733985901, -1.3973727226257324, 0.8680487275123596, 0.8478792905807495, 2.085404634475708, -0.11990775167942047, -1.225982666015625, -0.4207988977432251, -0.1865156590938568, -0.7631418704986572, -1.2214694023132324, 2.1198580265045166, 1.134118914604187, -0.43415993452072144, -0.2637162208557129, -1.6393098831176758, 1.1338121891021729, 1.2273838520050049, 0.2587362229824066, -0.03734230250120163, -1.6051907539367676, 0.3135172426700592, -1.6950453519821167, 0.6137235164642334, -0.45199817419052124, -0.7920563817024231, 1.8792531490325928, -1.5694084167480469, 0.4702691435813904, 1.6821322441101074, -0.8243587613105774, -1.7154293060302734, 0.18467965722084045, 0.3128727674484253, -0.38823211193084717, 0.5743176937103271, -0.09942452609539032, -0.48075059056282043, -1.0097566843032837, -2.102572202682495, -0.9426378607749939, 0.006482265889644623, -1.2706708908081055, 0.33873769640922546, -0.7549409866333008, 1.3939945697784424, 1.8424367904663086, -0.22796131670475006, 0.2755360007286072, 0.1191214770078659, 2.111477851867676, -0.031185034662485123, 1.663246512413025, 0.5092763900756836, 0.2502015233039856, 0.9713413715362549, 0.44268399477005005, 1.149606704711914, -2.0147438049316406, 1.9447201490402222, 0.7674269080162048, 1.7350561618804932, 0.07442595064640045, 1.2391889095306396, 1.1705923080444336, 1.5434714555740356, -2.165745258331299, 1.1882200241088867, 0.9004037380218506, -0.6043545603752136, 0.21423044800758362, -1.1670169830322266, 0.0165097638964653, -0.22824886441230774, -1.0526891946792603};
    float emb2[] = {0.13087981939315796, 0.617140531539917, -1.5033854246139526, 1.3711960315704346, -0.18263943493366241, 0.16997171938419342, 2.3820607662200928, -1.0976494550704956, -0.49371594190597534, 1.2625781297683716, -0.22802218794822693, -1.8041805028915405, -0.526003897190094, 0.17411842942237854, 0.37460362911224365, 0.9137892127037048, -0.9037493467330933, -0.11400140821933746, -1.872144341468811, -0.6360806822776794, -0.9397867918014526, 0.9753361344337463, -0.30907905101776123, -0.6436637043952942, 0.6283934116363525, 2.1041486263275146, 1.3387881517410278, 0.130538210272789, 1.0638291835784912, -0.8278176784515381, -0.6434407234191895, 2.2881879806518555, 1.333033561706543, 0.1932356357574463, 1.247344970703125, -0.7700365781784058, -0.38268551230430603, 0.13380873203277588, 0.8701772093772888, -1.2351914644241333, 1.50461745262146, 1.7360206842422485, 0.2257421761751175, -2.4753012657165527, 0.2947523593902588, -1.9360995292663574, -0.7948010563850403, 0.024847466498613358, -0.09740739315748215, 1.4389634132385254, -0.10764025151729584, -0.8147895336151123, 0.5654138922691345, 1.1358661651611328, -0.2118089497089386, 0.6255288124084473, 0.6940965056419373, -1.2130215167999268, -0.31449753046035767, -1.4386461973190308, -0.6560628414154053, -0.43129414319992065, -0.17143414914608002, 1.7638059854507446, -0.5045344233512878, 1.0330029726028442, 0.5331632494926453, 1.2517380714416504, 2.556398868560791, 0.08699154108762741, -0.8334450125694275, 0.03691425919532776, 0.9479920864105225, 0.028273649513721466, 0.11857613921165466, -0.824601411819458, 0.19297632575035095, -1.219609260559082, 1.208152413368225, -0.35229283571243286, 0.5013599991798401, 0.6227874755859375, -0.9894896745681763, -0.4432768225669861, 1.4133220911026, -0.002073340117931366, 1.7398500442504883, 0.39311283826828003, 0.34897422790527344, 2.292161703109741, -1.489317774772644, 1.5103180408477783, 1.4414572715759277, 1.1410865783691406, -0.33342617750167847, -0.42841729521751404, -0.45275428891181946, 0.8295294642448425, -2.0215189456939697, -0.4349959194660187, -0.9611812233924866, -0.3726956844329834, -1.3966877460479736, 0.14286163449287415, 2.1868207454681396, 0.30336636304855347, -0.5722492337226868, -0.5802507400512695, -1.4869019985198975, 2.04671049118042, 1.262114405632019, 2.0317296981811523, -1.1001920700073242, 1.8725078105926514, -1.1686584949493408, 0.482551246881485, -1.9954261779785156, -1.4278935194015503, 0.938932478427887, 0.30058935284614563, 0.5396802425384521, -0.03307456895709038, 0.7770190834999084, 1.339835524559021, 0.10885421931743622, 0.563071072101593, 1.703004002571106, 1.556715488433838};
    float emb3[] = {-0.45366987586021423, -0.25899356603622437, -2.425354242324829, 0.8898019790649414, 1.4445301294326782, -0.5178651809692383, 1.7501716613769531, -0.3647056221961975, 0.1736772358417511, 0.78913813829422, -0.06444982439279556, -0.4495542645454407, -1.3133786916732788, -0.4967610836029053, 0.46386533975601196, 0.5231691002845764, -0.6207765340805054, -0.5191023945808411, -0.9281334280967712, -0.35267171263694763, 1.046763300895691, 0.2501397728919983, 0.1508525013923645, -0.5147833228111267, 1.6156630516052246, 0.7614167332649231, -0.50105881690979, -0.5518260598182678, -0.7282920479774475, -0.4083007872104645, 0.6694389581680298, 0.6156255006790161, -1.2414699792861938, 1.581502914428711, 0.3307240307331085, -2.032984972000122, 0.5039116144180298, -1.153186321258545, -0.5192166566848755, -2.654294490814209, -2.11287784576416, 0.9781749844551086, -0.786007285118103, -0.6104771494865417, -0.7779949903488159, -2.2531983852386475, -0.4053199887275696, 1.0721794366836548, 0.2302059382200241, 2.1667332649230957, 0.2586618959903717, -0.37974682450294495, -0.5626779794692993, -0.47569191455841064, 0.6767090559005737, -1.8412692546844482, 2.1017866134643555, 0.4948657751083374, -1.4209048748016357, -0.5585839152336121, -2.3001039028167725, -0.1718074083328247, 0.6208766102790833, 0.6220746636390686, 0.27120935916900635, -0.8501607179641724, -1.2606528997421265, 0.8700671792030334, -0.6111212968826294, -0.45932018756866455, 1.4917817115783691, -2.3559536933898926, -1.3964192867279053, -0.5593035817146301, 0.39517879486083984, -0.7089547514915466, -0.025364331901073456, 0.4019467532634735, -0.23462733626365662, -0.4615994095802307, -0.5493746995925903, 0.37164586782455444, -0.6530917882919312, -1.5864933729171753, -1.3150951862335205, 2.098421335220337, -1.067777395248413, 0.9393583536148071, 0.11101789772510529, 0.005049634724855423, 1.3527799844741821, -1.113782286643982, -0.09720997512340546, -0.011697269976139069, 1.40937340259552, 0.6855466365814209, -0.9367457628250122, 0.2249007523059845, -0.36649519205093384, 0.35982179641723633, 0.1860170215368271, -0.2881316840648651, -0.5639775991439819, -1.7194932699203491, 0.0161939337849617, -1.9318795204162598, 0.48538947105407715, -1.6485514640808105, 0.11182060837745667, -0.10640072077512741, -2.4082930088043213, 0.1565132737159729, 1.3319294452667236, -0.256593257188797, 1.078938364982605, -1.4244529008865356, -0.21794059872627258, -0.24516552686691284, 0.44891294836997986, 1.7164753675460815, -0.08420170843601227, -0.7677295207977295, 0.6967589855194092, 0.31792017817497253, 0.6203148365020752, -0.4203808605670929, 0.6500713229179382, 1.0194650888442993};
    float emb4[] = {-0.3444824516773224, 0.3957308530807495, 1.1916395425796509, -0.5949933528900146, -0.06057170033454895, -0.2755972146987915, 0.6691650152206421, 0.78949373960495, 1.199083924293518, 1.5521435737609863, -1.787296175956726, 0.1690875142812729, -1.1313554048538208, 0.6233354806900024, -0.8923656940460205, -0.8250806927680969, -1.9628963470458984, -0.9626147747039795, -1.3179712295532227, -1.1844661235809326, 0.7339369058609009, -1.074603796005249, -0.915801465511322, -0.8999994993209839, -2.680684804916382, 0.8732487559318542, -0.6657688617706299, -0.6124828457832336, 0.04938749223947525, 1.042906641960144, 0.27802640199661255, 0.63856041431427, 0.47814053297042847, -1.9650886058807373, 1.220073938369751, -0.969035804271698, -2.018221139907837, 0.640932023525238, 0.7077299952507019, 0.8216730356216431, -0.6868153810501099, 0.32834339141845703, -0.3908195197582245, 0.10912209749221802, -0.3966069221496582, -0.2523846924304962, -0.5121811628341675, 1.7615693807601929, -1.123538613319397, -0.06918759644031525, 1.6276580095291138, 1.7832202911376953, 0.21234163641929626, -1.2876864671707153, 1.0771729946136475, -0.5904300212860107, -0.42133599519729614, -0.49832862615585327, -0.575025200843811, 1.518068790435791, 0.1255861222743988, -0.17974816262722015, -3.0156195163726807, -0.7997176647186279, 0.5721785426139832, -0.2930648922920227, -1.068603754043579, 1.684072732925415, 0.8004893660545349, 0.10932427644729614, -0.47739702463150024, -0.2639109194278717, 1.1439850330352783, -1.498402714729309, 1.5997024774551392, 0.9678308963775635, -0.42338722944259644, -0.44528138637542725, -0.6675369143486023, -1.591376543045044, 0.5033718943595886, -0.33471179008483887, 0.6122221946716309, -1.830485463142395, -1.9930661916732788, -1.024031162261963, -1.019924521446228, -0.5520651340484619, 1.4305510520935059, 0.190659299492836, -2.0403659343719482, 1.1248588562011719, -0.14571087062358856, 0.030190741643309593, 1.0649715662002563, 1.742930293083191, -1.176995873451233, 1.1136448383331299, 0.17300260066986084, -0.5261322259902954, 1.445635437965393, -0.04272829741239548, -3.1843690872192383, -1.400330901145935, 0.026010915637016296, -1.8383736610412598, 1.393062949180603, 0.11060348153114319, 1.440458059310913, 0.5884268283843994, 0.24727804958820343, 0.024794183671474457, -1.691043496131897, -0.6011244654655457, -1.011088252067566, 1.9053137302398682, 0.24062293767929077, -0.113981693983078, -1.136901617050171, -0.2654804289340973, 0.6875818967819214, -1.221598744392395, -1.4060215950012207, -0.2692178189754486, 0.06177660450339317, -0.08551202714443207, -0.790888249874115, -0.0527612641453743};
    float emb5[] = {-1.3849472999572754, -1.60749351978302, -0.17812448740005493, 0.5906571745872498, 0.9500745534896851, 1.2525949478149414, 0.34809428453445435, -0.19931043684482574, -0.36474910378456116, 1.8318804502487183, -0.4813762307167053, -1.7760344743728638, -0.22427688539028168, -0.8710949420928955, 0.5383366346359253, -0.29620057344436646, 1.538888692855835, -0.7108375430107117, -0.8333165049552917, -2.027801036834717, 0.5600541830062866, -0.5367048978805542, 0.8397340178489685, 0.9077188372612, -1.0174446105957031, -0.4252755343914032, 0.20350989699363708, -0.8788813352584839, -0.03247920423746109, 1.3429350852966309, 1.6828291416168213, -0.8164694309234619, 0.47501713037490845, -0.01259208470582962, 2.594102382659912, -0.34086722135543823, -1.1662253141403198, -0.21766585111618042, 1.0727310180664062, -0.38852277398109436, -0.3832145631313324, -0.21825340390205383, 0.8347722291946411, 0.19983837008476257, 1.1856881380081177, -0.8957820534706116, 0.775351881980896, -0.11067003011703491, -0.6185272336006165, -0.17154410481452942, -0.902362048625946, 0.8258640170097351, -0.15261483192443848, -0.6849628686904907, -0.7634403705596924, 0.9967895150184631, 0.9683685898780823, -1.7096360921859741, -0.7820016741752625, -1.594185471534729, -0.5965757966041565, -0.8294951915740967, 0.629070520401001, 0.13321374356746674, -1.1475613117218018, -0.34469538927078247, -0.13987493515014648, 1.2820230722427368, -1.2778412103652954, 0.019802898168563843, 0.5385782718658447, -0.20292089879512787, 0.20760442316532135, -2.3865647315979004, 1.7628028392791748, 0.35197123885154724, -0.19459958374500275, -0.12238436937332153, -2.027294635772705, -0.1903497725725174, -0.05181869864463806, 0.5272862911224365, -1.5566132068634033, -0.2354068160057068, 0.6722084283828735, -0.1996586173772812, -0.6255888938903809, -0.6845024228096008, -1.2259342670440674, -0.1397804617881775, -0.4060962498188019, 0.8317999243736267, -0.6176996827125549, 1.7343350648880005, 0.5526726245880127, 0.35262787342071533, -1.040667176246643, 0.7661591172218323, -1.5204484462738037, 0.12556348741054535, 0.916591227054596, 0.0010061822831630707, -0.3697841167449951, -0.5433762669563293, 0.20547953248023987, 0.09690067172050476, -1.3781213760375977, -1.2220051288604736, -0.013981908559799194, -0.023583021014928818, -0.8941890001296997, 1.4628125429153442, 0.23042917251586914, 0.1768122762441635, -1.0837717056274414, -0.712164044380188, -0.23876874148845673, -1.5390522480010986, -1.731106162071228, 0.6274563074111938, 0.6065899729728699, -1.4475351572036743, 1.525938868522644, -0.2932230234146118, 0.2395395189523697, -0.96598881483078, 0.9600178003311157, 0.5076695680618286};
    float emb6[] = {-0.06412193179130554, 0.2551606297492981, -0.7275811433792114, 1.2782191038131714, -0.1091289073228836, -0.21217618882656097, 0.8234052062034607, -0.8613783717155457, -1.0837461948394775, 0.7748649716377258, 0.8407785892486572, -1.0325313806533813, 1.2079170942306519, -3.1323938369750977, -0.8010386228561401, -1.1160670518875122, -0.8842581510543823, -1.3374918699264526, -0.4281831383705139, -0.9604334235191345, 1.1440880298614502, 1.295084834098816, 0.20877882838249207, -1.1331192255020142, -0.5724488496780396, 0.44908612966537476, -0.22096653282642365, 0.7302299737930298, 0.8705129623413086, 0.4743475914001465, 0.43050652742385864, 0.3625401258468628, 1.6172044277191162, -0.8275778293609619, 0.8771981596946716, -0.2397710382938385, 0.6205352544784546, -1.0422109365463257, -1.4588499069213867, -2.024195432662964, -0.09445233643054962, 1.446121335029602, -0.979377031326294, -0.75385582447052, 0.03749539703130722, 0.39570650458335876, 0.6036174297332764, 1.8719854354858398, -1.2394295930862427, -0.5304713249206543, 0.5349811315536499, -0.0830879658460617, -1.8909810781478882, 2.3588449954986572, -0.8050427436828613, 1.6000570058822632, -1.3527311086654663, -1.224747657775879, -0.939122200012207, -1.896894931793213, -0.6831530928611755, -0.9665787816047668, 0.9917721748352051, -0.7150743007659912, -0.36197200417518616, 0.4042509198188782, -1.1354217529296875, 2.671976327896118, -0.9796497821807861, 0.37239453196525574, 0.24981087446212769, -0.14006851613521576, -1.2289994955062866, -0.8712103366851807, -0.42360401153564453, 0.8762795925140381, 0.2331753671169281, 1.3690979480743408, -0.4860234558582306, -0.041540324687957764, 0.1944294571876526, -0.3310645818710327, -1.9486573934555054, 0.11792787909507751, 0.8688119053840637, -1.5163171291351318, -0.12969334423542023, -0.24560943245887756, 0.21871572732925415, -1.7915167808532715, 0.16237834095954895, 0.13249818980693817, 2.607632637023926, 0.892472505569458, 0.26959753036499023, 0.2654968500137329, 1.052696704864502, 0.6222046613693237, 0.3533407151699066, -1.511528491973877, 0.5442294478416443, -0.24063700437545776, 1.3969533443450928, -0.2506285309791565, -0.6970778703689575, 2.1905059814453125, -0.01820765621960163, -0.9708757400512695, 0.4143461585044861, 1.028206706047058, -1.417420506477356, -0.5556842684745789, -0.9132387638092041, 0.040391143411397934, 0.2836307883262634, 1.7109719514846802, -1.828515648841858, -2.079132318496704, -0.6257680058479309, 0.8198254704475403, -0.9932646751403809, 0.5872882604598999, 1.2248742580413818, 1.8980932235717773, 2.744414806365967, 0.3059980869293213, 0.04980010539293289, 2.4373509883880615};
    float emb7[] = {-0.7982070446014404, 0.02007092535495758, -0.6245542168617249, 0.2711060047149658, -2.533210039138794, 0.49877169728279114, 0.9291818141937256, -0.5426918864250183, -0.6351290941238403, 1.0227233171463013, -1.2614212036132812, 1.133979082107544, -0.3601146936416626, -1.393720269203186, 1.2884423732757568, 0.05432399362325668, 0.9599337577819824, -0.03879701346158981, 1.1644917726516724, -1.7527456283569336, 1.6544874906539917, -2.18795108795166, -0.9059284329414368, 0.24200883507728577, 2.272085428237915, -0.35902535915374756, 0.897834300994873, 1.2268390655517578, 1.9525129795074463, 0.9031361937522888, -0.32109254598617554, 0.6093040108680725, 0.030671242624521255, 0.24587765336036682, -0.42436712980270386, -2.544076919555664, -0.6581502556800842, -1.3306834697723389, -0.47583454847335815, -0.44384002685546875, 0.005947082303464413, 1.0791312456130981, 0.8468525409698486, 1.656424641609192, 1.02287757396698, 0.8257701992988586, -0.5108517408370972, -1.4407390356063843, 0.6155423521995544, -0.6668007373809814, -1.2000153064727783, 0.046638473868370056, -0.29752540588378906, 0.677854061126709, -0.3466399610042572, 1.4487125873565674, 1.0013172626495361, 0.5486155152320862, -0.8659390807151794, -0.19364041090011597, -1.4737390279769897, 0.5511184930801392, 0.5753039717674255, -0.632355809211731, 0.07856283336877823, 0.3710786700248718, -0.24214670062065125, 0.17953136563301086, -1.4419238567352295, -1.6300227642059326, 1.1550993919372559, 0.7828942537307739, 1.3619662523269653, -1.3426058292388916, 1.1061124801635742, -0.9402535557746887, 0.6261166334152222, 0.6480629444122314, 0.0008993297815322876, 1.4921795129776, -0.06630417704582214, 0.7749979496002197, -0.5966558456420898, -3.916011095046997, -0.5139392614364624, 0.4044572710990906, -2.078362464904785, 0.31123411655426025, -0.7404677867889404, 1.1013662815093994, 1.1946216821670532, 0.06398869305849075, -0.37938404083251953, 0.5129355192184448, 0.38928768038749695, -0.013769331388175488, -0.8624188303947449, 0.2694600522518158, -0.7046396136283875, 0.3466724157333374, 1.0543036460876465, 0.31427353620529175, 2.5382494926452637, 0.448784738779068, -0.5298044085502625, -0.8593869805335999, -0.9345490336418152, -0.536855936050415, -0.39990049600601196, 0.5634686946868896, -1.589452862739563, 0.27802541851997375, 0.22350016236305237, -0.8845364451408386, -0.12212099879980087, -1.4567500352859497, 0.8667299747467041, 1.4609769582748413, 1.7763978242874146, 0.243048295378685, 1.5482826232910156, -0.032238420099020004, 2.5445051193237305, 0.7104209661483765, 0.041890569031238556, 0.6007333397865295, 1.3166366815567017, 1.5392273664474487};
    kdtree_insere(&arv, aloca_reg(emb1, "a"));
    kdtree_insere(&arv, aloca_reg(emb2, "b"));
    kdtree_insere(&arv, aloca_reg(emb3, "c"));
    kdtree_insere(&arv, aloca_reg(emb4, "d"));
    kdtree_insere(&arv, aloca_reg(emb5, "e"));
    kdtree_insere(&arv, aloca_reg(emb6, "f"));
    tnode *raiz = arv.raiz;
    assert(strcmp(((treg *)raiz->dir->key)->nome, "b") == 0);
    assert(strcmp(((treg *)raiz->esq->key)->nome, "e") == 0);
    assert(strcmp(((treg *)raiz->dir->esq->key)->nome, "c")==0);
    assert(strcmp(((treg *)raiz->dir->esq->dir->key)->nome, "d")==0);
    printf("\n");
    treg *atual = aloca_reg(emb7, "x");
    tnode *mais_proximo = kdtree_busca(&arv, atual);
    assert(strcmp(((treg *)mais_proximo->key)->nome, "e") == 0);

    printf("\n");
    memcpy(atual->embed, emb1, EMBED_SIZE);
    mais_proximo = kdtree_busca(&arv, atual);
    assert(strcmp(((treg *)mais_proximo->key)->nome, "a") == 0);

    printf("\n");
    memcpy(atual->embed, emb4, EMBED_SIZE);
    mais_proximo = kdtree_busca(&arv, atual);
    assert(strcmp(((treg *)mais_proximo->key)->nome, "e") == 0);

    printf("\n");
    memcpy(atual->embed, emb6, EMBED_SIZE);
    mais_proximo = kdtree_busca(&arv, atual);
    assert(strcmp(((treg *)mais_proximo->key)->nome, "e") == 0);

    free(atual);
    kdtree_destroi(&arv);
}

int main(void)
{
    test_constroi();
    test_busca();
    printf("SUCCESS!!\n");
    return EXIT_SUCCESS;
}
